{% extends 'base.html' %}
{% load embed_video_tags i18n %}

{% block title %}{{ project.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Project Header -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>{{ project.title }}</h2>
                {% if is_owner %}
                <div>
                    <a href="{% url 'projects:project_update' project.pk %}" class="btn btn-ghost btn-sm">{% trans "Edit" %}</a>
                    <a href="{% url 'projects:project_delete' project.pk %}" class="btn btn-soft-danger btn-sm">{% trans "Delete" %}</a>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <!-- Cover Image -->
                {% if project.cover_image %}
                <div class="text-center mb-4">
                    <img src="{{ project.cover_image.url }}" alt="{{ project.title }}" class="img-fluid rounded" style="max-height: 400px;">
                </div>
                {% endif %}

                <!-- Project Info -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>{% trans "Type:" %}</strong> {{ project.get_project_type_display }}</p>
                        <p><strong>{% trans "Created:" %}</strong> {{ project.created_at|date:"F j, Y" }}</p>
                        <p><strong>{% trans "Status:" %}</strong> 
                            {% if project.is_published %}
                                <span class="badge bg-success">{% trans "Published" %}</span>
                            {% else %}
                                <span class="badge bg-warning">{% trans "Draft" %}</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "Categories:" %}</strong></p>
                        {% for category in project.categories.all %}
                        <span class="badge bg-primary me-1">{{ category.name }}</span>
                        {% empty %}
                        <span class="text-muted">{% trans "No categories" %}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <h5>{% trans "Description" %}</h5>
                    <p class="card-text">{{ project.description|linebreaks }}</p>
                </div>

                <!-- Video Embed -->
                {% if project.video_url %}
                <div class="mb-4">
                    <h5>{% trans "Video" %}</h5>
                    {% with v=project.video_url|lower %}
                        {% if '.mp4' in v or '.webm' in v or '.ogg' in v or '.ogv' in v or '.m3u8' in v %}
                            <video controls playsinline class="w-100" style="max-height: 480px; background:#000;" poster="{% if project.cover_image %}{{ project.cover_image.url }}{% endif %}">
                                <source src="{{ project.video_url }}" type="video/mp4">
                                <source src="{{ project.video_url }}" type="video/webm">
                                <source src="{{ project.video_url }}" type="video/ogg">
                                {% trans "Your browser does not support the video tag." %}
                            </video>
                        {% else %}
                            <div class="ratio ratio-16x9">
                                {% video project.video_url as my_video %}
                                    {% video my_video "medium" %}
                                {% endvideo %}
                            </div>
                        {% endif %}
                    {% endwith %}
                </div>
                {% endif %}

                <!-- Audio Player -->
                {% if project.audio_file %}
                <div class="mb-4">
                    <h5>{% trans "Audio" %}</h5>
                    <audio controls class="w-100">
                        <source src="{{ project.audio_file.url }}" type="audio/mpeg">
                        {% trans "Your browser does not support the audio element." %}
                    </audio>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Additional Images -->
        {% if project.images.all %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>{% trans "Gallery Images" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for image in project.images.all %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.caption }}" style="height: 200px; object-fit: cover;">
                            {% if image.caption %}
                            <div class="card-body">
                                <p class="card-text small">{{ image.caption }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Messages -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "Messages" %}</h5>
                <small class="text-muted">{% trans "Project owner:" %} {{ project.owner.username }}</small>
            </div>
            <div class="card-body">
                <div id="conversation" class="list-group mb-3"></div>
                <form id="messageForm" class="mt-3">
                    <div class="mb-2">
                        {% blocktrans with username=project.owner.username %}
                        {% endblocktrans %}
                        <textarea id="messageBody" class="form-control" rows="2" placeholder="{% blocktrans with username=project.owner.username %}Write a message to {{ username }}...{% endblocktrans %}"></textarea>
                    </div>
                    <button class="btn btn-soft-primary btn-sm">{% trans "Send" %}</button>
                </form>
            </div>
        </div>

        <!-- Additional Files -->
        {% if project.files.all %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>{% trans "Project Files" %}</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for file in project.files.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ file.get_file_type_display }}</strong>
                            {% if file.description %}
                            <br><small class="text-muted">{{ file.description }}</small>
                            {% endif %}
                        </div>
                        <a href="{{ file.file.url }}" class="btn btn-soft-primary btn-sm" download>{% trans "Download" %}</a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-md-4">
        <!-- Social / Engagement -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Engagement" %}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <button class="btn like-btn btn-sm {% if liked %}liked{% endif %}"
                            data-project-id="{{ project.id }}"
                            data-like-url="{% url 'projects:toggle_like' project.id %}">
                        <i class="{% if liked %}fas fa-heart{% else %}far fa-heart{% endif %}"></i>
                        <span class="ms-1">{% trans "Like" %}</span>
                    </button>
                    <span class="badge bg-light text-dark">{% trans "Likes:" %} <span class="like-count">{{ likes_count }}</span></span>
                </div>
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <button class="btn follow-btn btn-sm {% if is_following %}following{% endif %}"
                            data-user-id="{{ project.owner.id }}"
                            data-follow-url="{% url 'accounts:toggle_follow' project.owner.id %}">
                        <i class="{% if is_following %}fas fa-user-check{% else %}far fa-user{% endif %}"></i>
                        <span class="ms-1">{% if is_following %}{% trans "Following" %}{% else %}{% trans "Follow" %}{% endif %}</span>
                    </button>
                    <span class="badge bg-light text-dark">{% trans "Followers:" %} <span class="followers-count">{{ followers_count }}</span></span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>{% trans "Owner Following" %}</span>
                    <span class="badge bg-secondary">{{ following_count }}</span>
                </div>
            </div>
        </div>
        {% if is_owner %}
        <!-- Add Media Sidebar -->
        <div class="card">
            <div class="card-header">
                <h5>{% trans "Add Media" %}</h5>
            </div>
            <div class="card-body">
                <!-- Add Image Form -->
                <form method="post" action="{% url 'projects:add_project_image' project.pk %}" enctype="multipart/form-data" class="mb-3">
                    {% csrf_token %}
                    <h6>{% trans "Add Image" %}</h6>
                    <div class="mb-2">
                        <input type="file" name="image" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-2">
                        <input type="text" name="caption" class="form-control form-control-sm" placeholder="{% trans "Caption (optional)" %}">
                    </div>
                    <button type="submit" class="btn btn-success btn-sm w-100">{% trans "Add Image" %}</button>
                </form>

                <!-- Add File Form -->
                <form method="post" action="{% url 'projects:add_project_file' project.pk %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <h6>Add File</h6>
                    <div class="mb-2">
                        <input type="file" name="file" class="form-control form-control-sm" required>
                    </div>
                    <div class="mb-2">
                        <select name="file_type" class="form-select form-select-sm">
                            <option value="document">{% trans "Document" %}</option>
                            <option value="source">{% trans "Source File" %}</option>
                            <option value="asset">{% trans "Asset" %}</option>
                            <option value="other">{% trans "Other" %}</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <input type="text" name="description" class="form-control form-control-sm" placeholder="{% trans "File description" %}">
                    </div>
                    <button type="submit" class="btn btn-info btn-sm w-100">{% trans "Add File" %}</button>
                </form>
            </div>
        </div>

        <!-- Project Actions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>{% trans "Project Actions" %}</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if is_owner %}
                    <a href="{% url 'projects:project_update' project.pk %}" class="btn btn-ghost">{% trans "Edit Project" %}</a>
                    <a href="{% url 'projects:project_delete' project.pk %}" class="btn btn-soft-danger">{% trans "Delete Project" %}</a>
                    {% endif %}
                    <a href="{% url 'projects:dashboard' %}" class="btn btn-ghost">{% trans "Back to Dashboard" %}</a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    <script>
    (function(){
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            likeBtn.addEventListener('click', async function(){
                const url = this.dataset.likeUrl;
                const likeIcon = this.querySelector('i');
                const likeCountEl = document.querySelector('.like-count');
                try {
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrftoken,
                        }
                    });
                    if (resp.redirected) { window.location.href = resp.url; return; }
                    if (!resp.ok) throw new Error('Request failed');
                    const data = await resp.json();
                    likeCountEl.textContent = data.count;
                    if (data.liked) {
                        this.classList.add('liked');
                        likeIcon.className = 'fas fa-heart';
                    } else {
                        this.classList.remove('liked');
                        likeIcon.className = 'far fa-heart';
                    }
                } catch(e) { console.error(e); }
            });
        }

        // Follow toggle
        const followBtn = document.querySelector('.follow-btn');
        if (followBtn) {
            followBtn.addEventListener('click', async function(){
                const url = this.dataset.followUrl;
                const icon = this.querySelector('i');
                const text = this.querySelector('span');
                const followersCountEl = document.querySelector('.followers-count');
                try {
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrftoken,
                        }
                    });
                    if (resp.redirected) { window.location.href = resp.url; return; }
                    if (!resp.ok) throw new Error('Request failed');
                    const data = await resp.json();
                    followersCountEl.textContent = data.followers_count;
                    if (data.following) {
                        this.classList.add('following');
                        icon.className = 'fas fa-user-check';
                        text.textContent = 'Following';
                    } else {
                        this.classList.remove('following');
                        icon.className = 'far fa-user';
                        text.textContent = 'Follow';
                    }
                } catch(e) { console.error(e); }
            });
        }

        // Messages: load conversation
        const conversationEl = document.getElementById('conversation');
        const messageForm = document.getElementById('messageForm');
        const messageBody = document.getElementById('messageBody');
        const otherUserId = Number('{{ project.owner.id }}');

        async function loadConversation() {
            try {
                const resp = await fetch(`{% url 'core:get_conversation' 0 %}`.replace('0', otherUserId));
                if (resp.redirected) { window.location.href = resp.url; return; }
                if (!resp.ok) throw new Error('Failed to load conversation');
                const data = await resp.json();
                conversationEl.innerHTML = '';
                if (!data.messages.length) {
                    conversationEl.innerHTML = '<div class="text-muted">No messages yet.</div>';
                    return;
                }
                for (const m of data.messages) {
                    const item = document.createElement('div');
                    item.className = 'list-group-item';
                    item.innerHTML = `<div class="d-flex justify-content-between"><strong>${m.sender}</strong><small class="text-muted">${m.created_at}</small></div><div class="mt-2"></div>`;
                    item.querySelector('.mt-2').textContent = m.body;
                    conversationEl.appendChild(item);
                }
                conversationEl.scrollTop = conversationEl.scrollHeight;
            } catch (e) { console.error(e); }
        }

        if (conversationEl) {
            loadConversation();
        }

        if (messageForm) {
            messageForm.addEventListener('submit', async function(e){
                e.preventDefault();
                const body = messageBody.value.trim();
                if (!body) return;
                try {
                    const resp = await fetch(`{% url 'core:send_message' 0 %}`.replace('0', otherUserId), {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({ body })
                    });
                    if (resp.redirected) { window.location.href = resp.url; return; }
                    if (!resp.ok) throw new Error('Failed to send');
                    messageBody.value = '';
                    await loadConversation();
                } catch(e) { console.error(e); }
            });
        }
    })();
    </script>
    <style>
      /* Local button variants */
      .btn-soft-primary { color:#234; background:rgba(67,97,238,.12); border:1px solid rgba(67,97,238,.35); }
      .btn-soft-primary:hover { background:rgba(67,97,238,.2); }
      .btn-ghost { color:#495057; background:transparent; border:1px dashed rgba(108,117,125,.5); }
      .btn-ghost:hover { background:rgba(108,117,125,.08); }
      .btn-soft-danger { color:#7a1f28; background:rgba(220,53,69,.10); border:1px solid rgba(220,53,69,.35); }
      .btn-soft-danger:hover { background:rgba(220,53,69,.18); }

      /* Card header overrides (local) */
      .card > .card-header {
        background: rgba(67,97,238,.08);
        color: #234;
        border-bottom: 1px solid rgba(67,97,238,.25);
      }

      /* Engagement styles */
      .like-btn { color:#dc3545; background:rgba(220,53,69,.08); border:1px solid rgba(220,53,69,.35); }
      .like-btn:hover { background:rgba(220,53,69,.15); }
      .like-btn.liked { background:#dc3545; color:#fff; border-color:#dc3545; }
      .follow-btn { color:#234; background:rgba(67,97,238,.10); border:1px solid rgba(67,97,238,.35); }
      .follow-btn:hover { background:rgba(67,97,238,.18); }
      .follow-btn.following { background:#4361ee; color:#fff; border-color:#4361ee; }
    </style>
</div>
{% endblock %}