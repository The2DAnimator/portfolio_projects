{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Storage Controls" %}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">{% trans "Storage Controls" %}</h2>
    <div class="d-flex gap-2">
      <a href="{% url 'core:admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i>{% trans "Back" %}
      </a>
    </div>
  </div>

  <!-- Summary Bar -->
  <div class="row g-3 mb-3">
    <div class="col-6 col-md-3">
      <div class="card h-100"><div class="card-body py-2">
        <div class="text-muted small">{% trans "Total Users (page/all)" %}</div>
        <div class="fw-bold">{{ page_obj.paginator.count }} / {{ total_users }}</div>
      </div></div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100"><div class="card-body py-2">
        <div class="text-muted small">{% trans "Avg Usage (page)" %}</div>
        <div class="fw-bold">{{ avg_usage }} MB</div>
      </div></div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100"><div class="card-body py-2">
        <div class="text-muted small">{% trans "Near Quota (>=80%)" %}</div>
        <div class="fw-bold">{{ near_quota }}</div>
      </div></div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card h-100"><div class="card-body py-2">
        <div class="text-muted small">{% trans "Default Quota" %}</div>
        <div class="fw-bold">{{ default_quota_mb }} MB</div>
      </div></div>
    </div>
  </div>

  <!-- Header Toolbar: Search, Page size, Bulk actions -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-center">
        <div class="col-sm-6 col-md-5">
          <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="{% trans 'Search username or email' %}">
        </div>
        <div class="col-auto">
          <select name="page_size" class="form-select form-select-sm" onchange="this.form.submit()">
            {% for n in page_sizes %}
            <option value="{{ n }}" {% if page_size|stringformat:'s' == n|stringformat:'s' %}selected{% endif %}>{{ n }} / {% trans "page" %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary btn-sm" type="submit"><i class="fas fa-filter me-1"></i>{% trans "Apply" %}</button>
        </div>
      </form>
      <hr class="my-2">
      <form method="post" id="bulkForm" class="d-flex flex-wrap gap-2">
        {% csrf_token %}
        <input type="hidden" name="action" id="bulkAction" value="">
        <div class="btn-group btn-group-sm" role="group">
          <button class="btn btn-outline-secondary" type="button" onclick="setBulk('bulk_reset_quota')" title="{% trans 'Reset selected users to default quota' %}"><i class="fas fa-rotate-left me-1"></i>{% trans "Reset Quota" %}</button>
          <button class="btn btn-outline-danger" type="button" onclick="setBulk('bulk_clear_locations')" title="{% trans 'Clear device locations for selected users' %}"><i class="fas fa-location-crosshairs me-1"></i>{% trans "Clear Locations" %}</button>
          <button class="btn btn-outline-danger" type="button" onclick="setBulk('bulk_clear_logs')" title="{% trans 'Clear request logs for selected users' %}"><i class="fas fa-broom me-1"></i>{% trans "Clear Logs" %}</button>
        </div>
        <div class="text-muted small ms-auto">{% trans "Select rows below to enable bulk actions" %}</div>
      </form>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0" id="storageTable">
      <thead class="table-light sticky-top" style="top: 56px; z-index: 5;">
        <tr>
          <th style="width:36px;"><input type="checkbox" id="selectAll"></th>
          <th>{% trans "User" %}</th>
          <th class="text-end">{% trans "Used" %}</th>
          <th class="text-end">{% trans "Quota" %}</th>
          <th style="min-width:260px;">{% trans "Usage" %}</th>
          <th class="text-end">{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for row in usage_data %}
        <tr>
          <td><input type="checkbox" class="row-check" form="bulkForm" name="user_ids" value="{{ row.user.id }}"></td>
          <td>
            <div class="fw-semibold">@{{ row.user.username }}</div>
            <div class="text-muted small text-truncate" title="{{ row.user.email }}" style="max-width: 220px;">{{ row.user.email }}</div>
          </td>
          <td class="text-end">{{ row.used_mb }} MB</td>
          <td class="text-end">{% if row.quota_mb %}{{ row.quota_mb }} MB{% else %}<span class="text-muted">{% trans "Default" %} ({{ default_quota_mb }} MB)</span>{% endif %}</td>
          <td>
            <div class="position-relative" style="height: 10px;">
              <div class="progress" style="height: 10px;">
                <div class="progress-bar {% if row.percent >= 90 %}bg-danger{% elif row.percent >= 70 %}bg-warning{% else %}bg-success{% endif %}"
                     role="progressbar" style="width: {{ row.percent }}%"></div>
              </div>
              <div class="position-absolute top-50 start-50 translate-middle text-muted small" style="line-height:1;">{{ row.percent }}%</div>
            </div>
          </td>
          <td class="text-end">
            <div class="d-flex flex-wrap gap-1 justify-content-end">
              <form method="post" class="d-inline" title="{% trans 'Set quota' %}">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ row.user.id }}">
                <input type="hidden" name="action" value="set_quota">
                <div class="input-group input-group-sm" style="max-width: 220px;">
                  <span class="input-group-text"><i class="fas fa-database"></i></span>
                  <input type="number" name="quota_mb" class="form-control" min="0" step="1" placeholder="{% trans 'MB' %}">
                  <button class="btn btn-outline-primary" type="submit"><i class="fas fa-check"></i></button>
                </div>
              </form>
              <form method="post" class="d-inline" title="{% trans 'Use default quota' %}">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ row.user.id }}">
                <input type="hidden" name="action" value="reset_quota">
                <button class="btn btn-outline-secondary btn-sm" type="submit"><i class="fas fa-rotate-left"></i></button>
              </form>
              <form method="post" class="d-inline" onsubmit="return confirm('{% trans 'Clear all device location entries for this user?' %}');" title="{% trans 'Clear locations' %}">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ row.user.id }}">
                <input type="hidden" name="action" value="clear_locations">
                <button class="btn btn-outline-danger btn-sm" type="submit"><i class="fas fa-location-crosshairs"></i></button>
              </form>
              <form method="post" class="d-inline" onsubmit="return confirm('{% trans 'Clear all request log entries for this user?' %}');" title="{% trans 'Clear logs' %}">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ row.user.id }}">
                <input type="hidden" name="action" value="clear_logs">
                <button class="btn btn-outline-danger btn-sm" type="submit"><i class="fas fa-broom"></i></button>
              </form>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center text-muted py-3">{% trans "No users found." %}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <nav class="mt-3">
    <ul class="pagination pagination-sm justify-content-end">
      {% if page_obj.has_previous %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&page_size={{ page_size }}">{% trans "Previous" %}</a></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
      <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&page_size={{ page_size }}">{% trans "Next" %}</a></li>
      {% endif %}
    </ul>
  </nav>
</div>

<script>
  const selectAll = document.getElementById('selectAll');
  const checks = document.querySelectorAll('.row-check');
  function setBulk(action){
    if(!document.querySelector('.row-check:checked')){ alert('{% trans "Select at least one user." %}'); return; }
    document.getElementById('bulkAction').value = action;
    document.getElementById('bulkForm').submit();
  }
  if(selectAll){
    selectAll.addEventListener('change', function(){
      checks.forEach(c => c.checked = selectAll.checked);
    });
  }
</script>
{% endblock %}
