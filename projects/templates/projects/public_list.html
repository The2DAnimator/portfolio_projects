{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "All Projects" %}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
    <div class="d-flex align-items-center gap-3">
      <h2 class="mb-0">{% trans "All Projects" %}</h2>
      <span class="text-muted small">{{ projects|length }} {% trans "results" %}</span>
    </div>
    <form method="get" class="d-flex gap-2 align-items-center flex-wrap">
      <div class="input-group input-group-sm" style="min-width: 280px;">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="{% trans 'Search projects...' %}">
      </div>
      <select name="type" class="form-select form-select-sm" style="min-width: 180px;">
        <option value="">{% trans "All types" %}</option>
        {% for value,label in type_choices %}
          <option value="{{ value }}" {% if active_type == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <select name="category" class="form-select form-select-sm" style="min-width: 200px;">
        <option value="">{% trans "All categories" %}</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if active_category == c.id|stringformat:'s' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <select name="sort" class="form-select form-select-sm" style="min-width: 160px;">
        <option value="created" {% if sort == 'created' %}selected{% endif %}>{% trans "Newest" %}</option>
        <option value="likes" {% if sort == 'likes' %}selected{% endif %}>{% trans "Most Liked" %}</option>
        <option value="title" {% if sort == 'title' %}selected{% endif %}>{% trans "Title" %}</option>
      </select>
      <select name="dir" class="form-select form-select-sm" style="min-width: 120px;">
        <option value="desc" {% if dir == 'desc' %}selected{% endif %}>{% trans "Desc" %}</option>
        <option value="asc" {% if dir == 'asc' %}selected{% endif %}>{% trans "Asc" %}</option>
      </select>
      <button class="btn btn-soft-primary btn-sm" type="submit"><i class="fas fa-filter me-1"></i>{% trans "Apply" %}</button>
      <a href="{% url 'projects:public_projects' %}" class="btn btn-ghost btn-sm"><i class="fas fa-eraser me-1"></i>{% trans "Clear" %}</a>
    </form>
  </div>

  {% if projects %}
  <div class="row g-4">
    {% for project in projects %}
    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
      <div class="card h-100 shadow-sm border-0 project-card">
        <div class="ratio ratio-4x3 bg-light position-relative rounded-top overflow-hidden">
          {% if project.cover_image %}
          <img src="{{ project.cover_image.url }}" alt="{{ project.title }}" class="w-100 h-100 object-fit-cover">
          {% else %}
          <div class="d-flex w-100 h-100 align-items-center justify-content-center text-muted">
            <i class="fas fa-image fa-2x"></i>
          </div>
          {% endif %}
          <div class="position-absolute top-0 start-0 w-100 h-100 project-overlay"></div>
          <div class="position-absolute top-0 end-0 m-2">
            <span class="badge bg-danger bg-opacity-90"><i class="fas fa-heart me-1"></i>{{ project.likes_count|default:0 }}</span>
          </div>
        </div>
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0 text-truncate" title="{{ project.title }}">{{ project.title }}</h5>
            <span class="badge text-bg-primary ms-2">{{ project.get_project_type_display }}</span>
          </div>
          <p class="card-text text-muted small mb-3 line-clamp-2">{{ project.description|default:'' }}</p>
          <div class="mt-auto d-flex justify-content-between align-items-center small text-muted">
            <span class="text-truncate"><i class="fas fa-user me-1"></i>{{ project.owner.username }}</span>
            <span><i class="fas fa-calendar-alt me-1"></i>{{ project.created_at|date:"M d, Y" }}</span>
          </div>
        </div>
        <div class="card-footer bg-white border-0 pt-0 pb-3 px-3">
          <a href="{% url 'projects:project_view' project.pk %}" class="btn btn-soft-primary btn-sm w-100">
            <i class="fas fa-eye me-1"></i>{% trans "View Project" %}
          </a>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="text-center py-5 text-muted">
        <i class="fas fa-folder-open fa-3x mb-3"></i>
        <h5 class="mb-2">{% trans "No Projects Yet" %}</h5>
        <p class="mb-0">{% trans "Be the first to add a project to our community!" %}</p>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="d-flex justify-content-between align-items-center mt-4">
    <div class="text-muted small">
      {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}
    </div>
    <div class="d-flex align-items-center gap-2">
      <form method="get" class="d-flex align-items-center gap-2">
        <input type="hidden" name="q" value="{{ q }}"/>
        <input type="hidden" name="type" value="{{ active_type }}"/>
        <input type="hidden" name="category" value="{{ active_category }}"/>
        <input type="hidden" name="sort" value="{{ sort }}"/>
        <input type="hidden" name="dir" value="{{ dir }}"/>
        <label class="small text-muted">{% trans "Per page" %}</label>
        <select class="form-select form-select-sm" name="page_size" onchange="this.form.submit()">
          <option value="12" {% if page_size == 12 %}selected{% endif %}>12</option>
          <option value="24" {% if page_size == 24 %}selected{% endif %}>24</option>
          <option value="48" {% if page_size == 48 %}selected{% endif %}>48</option>
        </select>
      </form>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?q={{ q }}&type={{ active_type }}&category={{ active_category }}&sort={{ sort }}&dir={{ dir }}&page_size={{ page_size }}&page=1">«</a></li>
            <li class="page-item"><a class="page-link" href="?q={{ q }}&type={{ active_type }}&category={{ active_category }}&sort={{ sort }}&dir={{ dir }}&page_size={{ page_size }}&page={{ page_obj.previous_page_number }}">{% trans "Prev" %}</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">«</span></li>
            <li class="page-item disabled"><span class="page-link">{% trans "Prev" %}</span></li>
          {% endif %}

          <li class="page-item active"><span class="page-link">{{ page_obj.number }}</span></li>

          {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?q={{ q }}&type={{ active_type }}&category={{ active_category }}&sort={{ sort }}&dir={{ dir }}&page_size={{ page_size }}&page={{ page_obj.next_page_number }}">{% trans "Next" %}</a></li>
            <li class="page-item"><a class="page-link" href="?q={{ q }}&type={{ active_type }}&category={{ active_category }}&sort={{ sort }}&dir={{ dir }}&page_size={{ page_size }}&page={{ page_obj.paginator.num_pages }}">»</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">{% trans "Next" %}</span></li>
            <li class="page-item disabled"><span class="page-link">»</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
  {% endif %}
</div>

<style>
  .object-fit-cover { object-fit: cover; }
  .ratio-4x3 { aspect-ratio: 4 / 3; }
  .project-card { transition: transform .15s ease, box-shadow .15s ease; }
  .project-card:hover { transform: translateY(-2px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.08) !important; }
  .project-overlay { background: linear-gradient(180deg, rgba(0,0,0,0.05) 0%, rgba(0,0,0,0.15) 60%, rgba(0,0,0,0.25) 100%); pointer-events: none; }
  .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .line-clamp-2 { line-clamp: 2; }
  .badge { font-size: .72rem; padding: .38em .5em; }
  .card-body { padding-bottom: .75rem !important; }
  .card-footer { padding-top: .5rem !important; }
  .btn-sm i { font-size: .85em; }
  /* Button variants */
  .btn-soft-primary {
    color: #234; /* dark text for contrast */
    background: rgba(67, 97, 238, 0.12);
    border: 1px solid rgba(67, 97, 238, 0.35);
  }
  .btn-soft-primary:hover { background: rgba(67, 97, 238, 0.2); }
  .btn-ghost {
    color: #495057;
    background: transparent;
    border: 1px dashed rgba(108, 117, 125, 0.5);
  }
  .btn-ghost:hover { background: rgba(108, 117, 125, 0.08); }
  /* Pagination tweaks */
  .pagination .page-link { padding: .25rem .5rem; font-size: .825rem; }
  .pagination .page-item.active .page-link { background: #4361ee; border-color: #4361ee; }
</style>
{% endblock %}
