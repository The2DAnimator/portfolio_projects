{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% blocktrans with username=profile_user.username %}{{ username }}'s Profile{% endblocktrans %}{% endblock %}

{% block content %}
<div class="container py-4" id="profileRoot" {% if not is_owner %}data-other-user-id="{{ profile_user.id }}"{% endif %}>
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h4 class="mb-0">@{{ profile_user.username }}</h4>
            {% if not is_owner %}
              <button class="btn btn-sm btn-outline-primary follow-btn {% if is_following %}following{% endif %}"
                      data-user-id="{{ profile_user.id }}"
                      data-follow-url="{% url 'accounts:toggle_follow' profile_user.id %}"
                      data-follow-label="{% trans 'Follow' %}"
                      data-following-label="{% trans 'Following' %}">
                <i class="{% if is_following %}fas fa-user-check{% else %}far fa-user{% endif %}"></i>
                <span class="ms-1">{% if is_following %}{% trans "Following" %}{% else %}{% trans "Follow" %}{% endif %}</span>
              </button>
            {% endif %}
          </div>
          <div class="d-flex justify-content-between mb-2">
            <div>{% trans "Name" %}</div>
            <div class="text-muted small">{{ profile_user.get_full_name|default:profile_user.username }}</div>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <div>{% trans "Email" %}</div>
            <div class="text-muted small">{{ profile_user.email }}</div>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <div>{% trans "Followers" %}</div>
            <div class="badge bg-light text-dark followers-count">{{ followers_count }}</div>
          </div>
          <div class="d-flex justify-content-between">
            <div>{% trans "Following" %}</div>
            <div class="badge bg-light text-dark">{{ following_count }}</div>
          </div>
        </div>
      </div>

      {% if is_owner %}
      <div class="card mt-3">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="mb-0">{% trans "Account Settings" %}</h6>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <a href="{% url 'accounts:password_change' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <span><i class="fas fa-key me-2"></i>{% trans "Change Password" %}</span>
              <i class="fas fa-chevron-right text-muted"></i>
            </a>
            <a href="{% url 'accounts:email_2fa_setup' %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <span><i class="fas fa-shield-alt me-2"></i>{% trans "Email Two-Factor Authentication" %}</span>
              <i class="fas fa-chevron-right text-muted"></i>
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      {% if not is_owner %}
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">{% blocktrans with username=profile_user.username %}Message {{ username }}{% endblocktrans %}</h6>
        </div>
        <div class="card-body">
          <div id="conversation" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;" data-no-messages="{% trans 'No messages yet.' %}"></div>
          <form id="messageForm">
            <div class="mb-2"><textarea id="messageBody" class="form-control" rows="2" placeholder="{% trans 'Write a message...' %}"></textarea></div>
            <button class="btn btn-primary btn-sm" type="submit">{% trans "Send" %}</button>
          </form>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">{% trans "Projects" %}</h5>
          {% if is_owner %}<a href="{% url 'projects:project_create' %}" class="btn btn-sm btn-primary">{% trans "New Project" %}</a>{% endif %}
        </div>
        <div class="card-body">
          {% if projects %}
          <div class="row g-3">
            {% for p in projects %}
            <div class="col-md-6">
              <div class="card h-100">
                {% if p.cover_image %}
                <img src="{{ p.cover_image.url }}" class="card-img-top" style="height: 180px; object-fit: cover;" alt="{{ p.title }}">
                {% endif %}
                <div class="card-body d-flex flex-column">
                  <h6 class="mb-1">{{ p.title }}</h6>
                  <small class="text-muted mb-2">{{ p.created_at|date:"M d, Y" }} â€¢ {{ p.get_project_type_display }}</small>
                  <p class="text-muted small mb-3">{{ p.description|truncatewords:20 }}</p>
                  <div class="mt-auto d-flex justify-content-between align-items-center">
                    {% if is_owner %}
                      <div class="btn-group" role="group">
                        <a href="{% url 'projects:project_detail' p.pk %}" class="btn btn-outline-primary btn-sm">{% trans "View" %}</a>
                        <a href="{% url 'projects:project_update' p.pk %}" class="btn btn-outline-secondary btn-sm">{% trans "Edit" %}</a>
                        <a href="{% url 'projects:project_delete' p.pk %}" class="btn btn-outline-danger btn-sm">{% trans "Delete" %}</a>
                      </div>
                    {% else %}
                      <a href="{% url 'projects:project_view' p.pk %}" class="btn btn-outline-secondary btn-sm">View</a>
                    {% endif %}
                    <span class="text-muted small"><i class="far fa-heart me-1"></i>{{ p.likes.count }}</span>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center text-muted py-4">{% trans "No published projects yet." %}</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Follow toggle
  const followBtn = document.querySelector('.follow-btn');
  if (followBtn) {
    followBtn.addEventListener('click', async function(){
      const url = this.dataset.followUrl;
      const icon = this.querySelector('i');
      const text = this.querySelector('span');
      const followersCountEl = document.querySelector('.followers-count');
      try {
        const resp = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken } });
        if (resp.redirected) { window.location.href = resp.url; return; }
        if (!resp.ok) throw new Error('Request failed');
        const data = await resp.json();
        followersCountEl.textContent = data.followers_count;
        const followLabel = this.dataset.followLabel || 'Follow';
        const followingLabel = this.dataset.followingLabel || 'Following';
        if (data.following) { this.classList.add('following'); icon.className = 'fas fa-user-check'; text.textContent = followingLabel; }
        else { this.classList.remove('following'); icon.className = 'far fa-user'; text.textContent = followLabel; }
      } catch(e) { console.error(e); }
    });
  }

  // Messaging (only when not owner)
  const conversationEl = document.getElementById('conversation');
  const rootEl = document.getElementById('profileRoot');
  const messageForm = document.getElementById('messageForm');
  const messageBody = document.getElementById('messageBody');
  const otherUserId = rootEl && rootEl.dataset.otherUserId ? Number(rootEl.dataset.otherUserId) : null;

  async function loadConversation(){
    if (!conversationEl || !otherUserId) return;
    try {
      const resp = await fetch(`{% url 'core:get_conversation' 0 %}`.replace('0', otherUserId));
      if (resp.redirected) { window.location.href = resp.url; return; }
      if (!resp.ok) throw new Error('Failed to load');
      const data = await resp.json();
      conversationEl.innerHTML = '';
      if (!data.messages.length) { conversationEl.innerHTML = `<div class="text-muted">${conversationEl.dataset.noMessages || ''}</div>`; return; }
      for (const m of data.messages) {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `<div class="d-flex justify-content-between"><strong>${m.sender}</strong><small class="text-muted">${m.created_at}</small></div><div class="mt-2"></div>`;
        item.querySelector('.mt-2').textContent = m.body;
        conversationEl.appendChild(item);
      }
      conversationEl.scrollTop = conversationEl.scrollHeight;
    } catch(e) { console.error(e); }
  }

  if (conversationEl) { loadConversation(); }

  if (messageForm) {
    messageForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const body = messageBody.value.trim();
      if (!body || !otherUserId) return;
      try {
        const resp = await fetch(`{% url 'core:send_message' 0 %}`.replace('0', otherUserId), {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({ body })
        });
        if (resp.redirected) { window.location.href = resp.url; return; }
        if (!resp.ok) throw new Error('Failed to send');
        messageBody.value = '';
        await loadConversation();
      } catch(e) { console.error(e); }
    });
  }
})();
</script>
{% endblock %}
